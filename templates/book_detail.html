<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>{{ book['é¢˜å'] }} - ä¹¦ç±è¯¦æƒ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body class="bg-light">

  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/">ğŸ“š é¦–é¡µ</a>
      <div class="ms-auto">
        {% if current_reader %}
          <!-- å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºå…¶è¯»è€…è¯å·å¹¶é“¾æ¥åˆ°æˆ‘çš„ä¸»é¡µ -->
          <span class="navbar-text text-muted small">
            ğŸ“Œ <a href="{{ url_for('my_page') }}" class="text-decoration-none text-muted">
                  {{ current_reader.nickname or current_reader.reader_card }}
                </a>
          </span>
        {% else %}
          <!-- å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªç™»å½•æç¤º -->
          <span class="navbar-text text-muted small">
            è¯·ä»å¾®ä¿¡èœå•è¿›å…¥ä»¥ç™»å½•
          </span>
        {% endif %}
      </div>
    </div>
  </nav>

    <!-- ä¸»ä½“å†…å®¹ -->
      <div class="container-sm my-4">
        <!-- ä¹¦ç±ä¿¡æ¯ -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-4">
              <!-- å·¦ä¾§ï¼šå°é¢ -->
              <div class="col-md-4 text-center">
                {% if book.cover_path and book.cover_path != 'æœªæ‰¾åˆ°ä¹¦ç±é“¾æ¥' %}
                  <img src="{{ url_for('static', filename=book.cover_path.replace('\\', '/')) }}"
                       class="img-fluid rounded shadow-sm" alt="{{ book.é¢˜å }} å°é¢" style="max-height: 400px;">
                {% else %}
                  <img src="https://via.placeholder.com/300x450/f8f9fa/6c757d?text={{ book.é¢˜å|urlencode }}"
                       class="img-fluid rounded" alt="æš‚æ— å°é¢" style="max-height: 400px;">
                {% endif %}
              </div>

              <!-- å³ä¾§ï¼šä¹¦ç±ä¿¡æ¯ -->
              <div class="col-md-8">
                <h4 class="card-title mb-3">{{ book.é¢˜å }}</h4>
                <p><strong>ä½œè€…ï¼š</strong>{{ book.è´£ä»»è€… }}</p>
                <p><strong>å‡ºç‰ˆç¤¾ï¼š</strong>{{ book.å‡ºç‰ˆç¤¾ }}ï¼ˆ{{ book.å‡ºç‰ˆå¹´ }}ï¼‰</p>
                <p><strong>ç´¢ä¹¦å·ï¼š</strong>{{ book.ç´¢ä¹¦å· }}</p>
                <p><strong>é¦†è—åœ°ï¼š</strong>{{ book.é¦†è—åœ° }}</p>
                <hr>
                <p><strong>ç®€ä»‹ï¼š</strong>{{ book.ç®€ä»‹ }}</p>
              </div>
            </div>
          </div>
        </div>

    <!-- å‘å¸ƒæ„Ÿæ‚Ÿ -->
    {% if current_reader %}
      <!-- åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½çœ‹åˆ°å‘å¸ƒæ„Ÿæ‚Ÿçš„è¡¨å• -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">ğŸ“ å‘å¸ƒæ„Ÿæ‚Ÿ</h5>
          <form method="post" action="{{ url_for('post_reflection') }}">
            <input type="hidden" name="book_id" value="{{ book['åºå·'] }}">
            <!-- åŠ¨æ€è®¾ç½® reader_card -->
            <input type="hidden" name="reader_card" value="{{ current_reader.reader_card }}">
            <div class="mb-3">
              <textarea class="form-control" name="content" rows="3" placeholder="è¯·è¾“å…¥ä½ çš„æ„Ÿæ‚Ÿ..." required></textarea>
            </div>
            <button type="submit" class="btn btn-success">å‘å¸ƒ</button>
          </form>
        </div>
      </div>
    {% endif %}

    <!-- æ¨èä¹¦ç± -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">ğŸ“š æ¨èä¹¦ç±ï¼ˆåŒä½œè€…ï¼‰</h5>
            {% if recommendations %}
              <ul class="list-group list-group-flush">
                {% for rec in recommendations %}
                  <li class="list-group-item">
                    <a href="{{ url_for('book_detail', book_id=rec['åºå·']) }}" class="text-decoration-none">{{ rec['é¢˜å'] }}</a>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">æš‚æ— æ¨èã€‚</p>
            {% endif %}
          </div>
        </div>

    <!-- æ„Ÿæ‚Ÿåˆ—è¡¨ -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">ğŸ’¬ æ„Ÿæ‚Ÿåˆ†äº«</h5>
        {% if reflections %}
          {% for r in reflections %}
            <div class="border-bottom pb-3 mb-3">
              <p class="mb-1">{{ r.content }}</p>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  <!-- ä½¿ç”¨ or è¯­æ³•ä¼˜å…ˆæ˜¾ç¤ºæ˜µç§° -->
                  ğŸ‘¤ {{ r.nickname or r.reader_card }}<br>
                  ğŸ•’ {{ r.timestamp.strftime('%Y-%m-%d %H:%M') }}
                </small>
                <div> <!-- ä½¿ç”¨ä¸€ä¸ª div åŒ…è£¹æŒ‰é’® -->
                  {% if current_reader %}
                    <!-- ç‚¹èµæŒ‰é’® -->
                    <button class="btn btn-outline-primary btn-sm like-btn" data-id="{{ r.reflection_id }}">
                      ğŸ‘ <span>{{ r.likes }}</span>
                    </button>
                  {% else %}
                     <!-- æœªç™»å½•ç”¨æˆ·åªæ˜¾ç¤ºç‚¹èµæ•° -->
                    <span class="text-muted">ğŸ‘ {{ r.likes }}</span>
                  {% endif %}
                   <!-- æ–°å¢ï¼šç®¡ç†å‘˜åˆ é™¤æŒ‰é’® -->
                  {% if current_reader and current_reader.is_admin %}
                    <form method="POST" action="{{ url_for('delete_reflection', reflection_id=r.reflection_id) }}" style="display: inline-block; margin-left: 5px;">
                      <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('ç¡®å®šè¦éšè—è¿™æ¡æ„Ÿæ‚Ÿå—ï¼Ÿ');" title="éšè—æ­¤æ¡æ„Ÿæ‚Ÿ">
                        ğŸ—‘ï¸
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">è¿˜æ²¡æœ‰äººå‘è¡¨æ„Ÿæ‚Ÿã€‚</p>
        {% endif %}
      </div>
    </div>
  </div>

  {% if current_reader %}
    <!-- åªæœ‰ç™»å½•ç”¨æˆ·æ‰éœ€è¦ç‚¹èµçš„ JS åŠŸèƒ½ -->
    <script>
      $(document).ready(function () {
        // å°† reader_card ä½œä¸ºä¸€ä¸ª JS å˜é‡ï¼Œæ–¹ä¾¿ä½¿ç”¨
        const currentUserCard = "{{ current_reader.reader_card }}";

        $('.like-btn').click(function () {
          const btn = $(this);
          const reflectionId = btn.data('id');
          $.post('/like', {
            reflection_id: reflectionId,
            // åŠ¨æ€ä¼ å…¥å½“å‰ç”¨æˆ·çš„ reader_card
            reader_card: currentUserCard
          }, function (data) {
            if (data.likes !== undefined) {
              btn.find('span').text(data.likes);
            }
          });
        });
      });
    </script>
  {% endif %}
  <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
</body>
</html>